<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MoodMap ‚Äì Profile</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- ‚úÖ Cropper.js CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">

<style>
  :root{
    --accent:#a78bfa;
    --accent2:#22d3ee;
    --text:#e5e7eb;
  }
  body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;

  background:
    repeating-linear-gradient(
      0deg,
      rgba(59,130,246,0.12),
      rgba(59,130,246,0.12) 1px,
      transparent 1px,
      transparent 24px
    ),
    repeating-linear-gradient(
      90deg,
      rgba(59,130,246,0.12),
      rgba(59,130,246,0.12) 1px,
      transparent 1px,
      transparent 24px
    ),
    radial-gradient(circle at 30% 30%, #c7bfff 0%, transparent 45%),
    radial-gradient(circle at 80% 70%, #9eeaff 0%, transparent 45%),
    #eef6ff;

  font-family:'Press Start 2P', monospace;
  overflow-x:hidden;
  background-size: 24px 24px, 24px 24px, auto, auto;
  animation: gridDrift 40s linear infinite;
}

@keyframes gridDrift{
  from { background-position: 0 0, 0 0, center, center; }
  to   { background-position: 24px 24px, 24px 24px, center, center; }
}

  .wrap{max-width:1050px;margin:auto;padding:40px 22px 90px;}
  .topRow{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:18px;}
  .brand{font-weight:1000;font-size:22px;}
  .btn{
  padding:10px 14px;
  border:3px solid #000;
  background:#fff;
  font-family:'Press Start 2P', monospace;
  font-size:10px;
  cursor:pointer;
  box-shadow:4px 4px 0 #000;
  text-decoration:none;
  color:#000;
}

.btn:hover{
  transform:translate(-2px,-2px);
  box-shadow:6px 6px 0 #000;
}

.btn:active{
  transform:translate(2px,2px);
  box-shadow:2px 2px 0 #000;
}

.btn.primary{
  background:#9ae6ff;
}

  .grid{display:grid;grid-template-columns: 1fr 1fr;gap:18px;margin-top:18px;}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}

  .card{
  background:#fff;
  border:3px solid #000;
  border-radius:8px;
  box-shadow:
    6px 6px 0 #000,
    10px 10px 0 rgba(0,0,0,0.08);
  padding:18px;
}

  .profileRow{display:flex;gap:14px;align-items:center;}
  .pfp{
  width:72px;
  height:72px;
  border:3px solid #000;
  background:#e5e7eb;
  box-shadow:3px 3px 0 #000;
  border-radius:8px;
  overflow:hidden;
  display:grid;
  place-items:center;
  font-weight:1000;
}

  .pfp img{width:100%;height:100%;object-fit:cover}
  .name{font-weight:1000;font-size:18px}
  .user{opacity:.7;font-size:13px;margin-top:6px}
  .metaRow{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
  .badge{
  padding:6px 10px;
  border:2px solid #000;
  background:#e0f7ff;
  font-size:10px;
}


  /* ‚úÖ Followers/Following row */
  .ffRow{
    margin-top:12px;
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
  }
  .ffPill{
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(0,0,0,0.22);
    padding:10px 12px;
    border-radius:999px;
    cursor:pointer;
    user-select:none;
    transition: transform .15s ease, border-color .15s ease;
    font-weight:1000;
    font-size:12px;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .ffPill:hover{
    transform: translateY(-2px);
    border-color: rgba(255,255,255,0.22);
  }
  .ffNum{
    font-weight:1000;
    font-size:13px;
  }
  .ffLabel{opacity:.75;font-weight:900}

  .places{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px;}
  .place{
    border-radius:18px;border:1px solid rgba(255,255,255,0.14);
    background:rgba(0,0,0,0.22);
    padding:12px;cursor:pointer;transition: transform .15s ease;
  }
  .place:hover{transform:translateY(-4px)}
  .pTitle{font-weight:1000;font-size:13px}
  .pMeta{opacity:.65;font-size:12px;margin-top:7px}
  .lockBox{
    margin-top:12px;padding:16px;border-radius:18px;
    border:1px solid rgba(255,255,255,0.14);
    background: rgba(0,0,0,0.22);
    opacity:.9;line-height:1.6;font-size:13px;
  }

  /* share card */
  .shareCard{
  background:#fff;
  border:3px solid #000;
  border-radius:8px;
  box-shadow:
    6px 6px 0 #000,
    10px 10px 0 rgba(0,0,0,0.08);
  padding:18px;
}

  .shareTitle{font-weight:1000;font-size:14px}
  .shareSub{opacity:.7;font-size:12px;margin-top:7px;line-height:1.5}
  .shareInner{
    margin-top:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.06);
    padding:16px;
  }
  .qr{margin-top:12px;opacity:.72;font-size:12px;}
  .hint{opacity:.65;font-size:12px;margin-top:12px}

  /* ‚úÖ Cropper modal */
  #cropBackdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.55);
    backdrop-filter: blur(10px);
    z-index:200;
    opacity:0;
    pointer-events:none;
    transition: opacity .2s ease;
  }
  #cropBackdrop.active{
    opacity:1;
    pointer-events:auto;
  }

  #cropModal{
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%) scale(.96);
    width:min(560px,92vw);
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.18);
    background:linear-gradient(180deg, rgba(20,25,40,0.92), rgba(10,12,20,0.78));
    backdrop-filter: blur(20px);
    z-index:201;
    padding:16px;
    box-shadow: 0 60px 160px rgba(0,0,0,0.75);
    opacity:0;
    pointer-events:none;
    transition: opacity .2s ease, transform .2s ease;
  }
  #cropModal.active{
    opacity:1;
    pointer-events:auto;
    transform:translate(-50%,-50%) scale(1);
  }

  .cropTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  .cropTitle{
    font-weight:1000;
    font-size:14px;
  }
  .cropClose{
    width:36px;height:36px;border-radius:14px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(0,0,0,0.22);
    color:white;
    cursor:pointer;
    font-weight:1000;
  }

  .cropArea{
    margin-top:12px;
    border-radius:8px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.14);
    background: rgba(0,0,0,0.22);
  }
  .cropArea img{
    width:100%;
    display:block;
    max-height:420px;
    object-fit:contain;
  }

  .cropActions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:12px;
  }

  .miniBtn{
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(255,255,255,0.16);
    background:rgba(0,0,0,0.24);
    color:white;cursor:pointer;font-weight:1000;
    transition: transform .15s ease;
  }
  .miniBtn:hover{transform:translateY(-2px)}
  .miniBtn.primary{
    border:none;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
  }

  /* ===================== FOLLOW LIST MODAL ===================== */
  #ffBackdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.4);
    backdrop-filter: blur(12px);
    z-index:999;
    opacity:0;
    pointer-events:none;
    transition: opacity .18s ease;
    display: none;
  }
  #ffBackdrop.active{
    opacity:1;
    pointer-events:auto;
    display: block;
  }

  #ffModal{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: min(560px, 92vw);
  max-height: 76vh;
  overflow: hidden;

  background: #fff;
  border: 3px solid #000;
  box-shadow: 6px 6px 0 #000;

  z-index: 1000;

  display: none;   /* important */
}



  #ffModal.active{
    display: block;
    opacity:1;
    pointer-events:auto;
    transform:translate(-50%,-50%) scale(1);
  }

  .ffTop{
  padding:10px 12px;
  background:#dcd7ff;
  border-bottom:3px solid #000;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

  .ffTitle{
    font-weight:1000;
    font-size:14px;
    letter-spacing: 0.2px;
  }
  .ffClose{
    width:38px;height:38px;border-radius:14px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(0,0,0,0.22);
    color:white;
    cursor:pointer;
    font-weight:1000;
  }

  .ffTabs{
    padding:10px 14px 12px;
    display:flex;
    gap:10px;
    border-bottom: 1px solid rgba(255,255,255,0.10);
  }
  .tabBtn{
    flex:1;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(0,0,0,0.22);
    color:white;
    font-weight:1000;
    cursor:pointer;
    transition: transform .15s ease, border-color .15s ease;
  }
  .tabBtn:hover{transform: translateY(-1px)}
  .tabBtn.active{
    border:none;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
  }

  /* ‚úÖ NEW: Search bar inside modal */
  .ffSearchWrap{
    padding:10px 14px 14px;
    border-bottom: 1px solid rgba(255,255,255,0.10);
  }
  .ffSearch{
    width:100%;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(0,0,0,0.22);
    color:white;
    outline:none;
    font-size:13px;
  }
  .ffSearch:focus{
    border-color: rgba(255,255,255,0.22);
    box-shadow: 0 25px 80px rgba(167,139,250,0.12);
  }

  .ffBody{
    padding:10px 14px 14px;
    overflow:auto;
    max-height:calc(min(76vh,680px) - 176px);
  }

  .ffItem{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(0,0,0,0.22);
    margin-bottom:10px;
  }
  .ffLeft{
    display:flex;
    gap:10px;
    align-items:center;
    min-width:0;
  }
  .ffAvatar{
    width:46px;height:46px;border-radius:18px;
    border:1px solid rgba(255,255,255,0.14);
    overflow:hidden;
    background:rgba(0,0,0,0.22);
    display:grid;place-items:center;
    font-weight:1000;
  }
  .ffAvatar img{width:100%;height:100%;object-fit:cover}
  .ffName{
    font-weight:1000;
    font-size:13px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:260px;
  }
  .ffUser{
    opacity:.72;
    font-size:12px;
    margin-top:6px;
  }

  /* ‚úÖ NEW: Relationship labels */
  .ffLabels{
    margin-top:8px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .relBadge{
    font-size:11px;
    padding:7px 10px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.20);
    font-weight:1000;
    opacity:.95;
    display:inline-flex;
    align-items:center;
    gap:7px;
  }
  .relBadge.mutual{
    border-color: rgba(34,211,238,0.35);
    background: rgba(34,211,238,0.16);
  }
  .relBadge.followsyou{
    border-color: rgba(167,139,250,0.35);
    background: rgba(167,139,250,0.16);
  }

  .ffActionBtn{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(0,0,0,0.22);
    color:white;
    font-weight:1000;
    cursor:pointer;
    transition: transform .15s ease;
  }
  .ffActionBtn:hover{transform: translateY(-2px)}
  .ffActionBtn.danger{
    border-color: rgba(239,68,68,0.35);
    background: rgba(239,68,68,0.16);
  }
  .ffEmpty{
    opacity:.7;
    padding:18px 6px;
    font-size:13px;
    line-height:1.6;
  }

  .pixelTitle{
  margin:-18px -18px 16px;
  padding:10px 12px;
  background:#dcd7ff;
  border-bottom:3px solid #000;
  display:flex;
  align-items:center;
  gap:10px;
  font-size:12px;
}

.logo{
  width:18px;
  height:18px;
  border:2px solid #000;
  background:#9ae6ff;
  display:grid;
  place-items:center;
  font-size:10px;
}

</style>
</head>

<body
  data-owner="{% if is_owner %}1{% else %}0{% endif %}"
  data-admin="{% if admin %}1{% else %}0{% endif %}"
>
<div class="wrap">

  <!-- ‚úÖ Cropper modal -->
  <div id="cropBackdrop"></div>
  <div id="cropModal">
    <div class="cropTop">
      <div class="cropTitle">Adjust Profile Picture</div>
      <button class="cropClose" id="cropCloseBtn">‚úï</button>
    </div>

    <div class="cropArea">
      <img id="cropImage" alt="cropper" />
    </div>

    <div class="cropActions">
      <button class="miniBtn" type="button" id="zoomInBtn">Ôºã Zoom</button>
      <button class="miniBtn" type="button" id="zoomOutBtn">Ôºç Zoom</button>
      <button class="miniBtn" type="button" id="rotateBtn">‚ü≤ Rotate</button>

      <button class="miniBtn primary" type="button" id="saveCropBtn" style="margin-left:auto;">‚úÖ Save</button>
    </div>
  </div>

  <!-- ‚úÖ Followers/Following modal -->
  <div id="ffBackdrop"></div>
  <div id="ffModal">
    <div class="ffTop">
      <div class="ffTitle" id="ffTitle">Connections</div>
      <button class="ffClose" id="ffCloseBtn">‚úï</button>
    </div>

    <div class="ffTabs">
      <button class="tabBtn active" id="tabFollowers">Followers</button>
      <button class="tabBtn" id="tabFollowing">Following</button>
    </div>

    <!-- ‚úÖ NEW: search bar -->
    <div class="ffSearchWrap">
      <input id="ffSearch" class="ffSearch" placeholder="Search users in this list‚Ä¶" autocomplete="off" />
    </div>

    <div class="ffBody" id="ffList">
      <div class="ffEmpty">Loading‚Ä¶</div>
    </div>
  </div>

  <div class="topRow">
    <div class="brand">MoodMap</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <a class="btn" href="/">‚Üê Home</a>

      {% if viewer_logged_in and not is_owner %}
        {% if relationship == "accepted" %}
          <button class="btn" id="unfollowBtn">Following ‚úì</button>
        {% elif relationship == "pending" %}
          <button class="btn" disabled>Requested ‚è≥</button>
        {% else %}
          <button class="btn primary" id="followBtn">Follow</button>
        {% endif %}
      {% endif %}

      <button class="btn primary" id="shareBtn"> Share</button>
    </div>
  </div>

  <div class="grid">

    <div class="card">
      <div class="profileRow">
        <div class="pfp" id="profilePfpBox">
          {% if profile_pic %}
            <img id="profilePfpImg" src="{{profile_pic}}" />
          {% else %}
            {{profile_name[:1]}}
          {% endif %}
        </div>

        <div style="min-width:0;">
          <div class="name">{{profile_name}}</div>
          <div class="user">@{{profile_username}}</div>

          <div class="metaRow">
            <span class="badge">Mood: {{current_mood}}</span>
            <span class="badge">{% if is_private %}Private{% else %}Public{% endif %}</span>
          </div>

          {% if is_owner %}
          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" onclick="document.getElementById('pfpFile').click()">Change picture</button>
            <input id="pfpFile" type="file" accept="image/png,image/jpeg,image/webp" style="display:none"/>

            <button class="btn" id="deleteAccountBtn" style="background:rgba(239,68,68,0.22);border-color:rgba(239,68,68,0.35);">
               Delete my account
            </button>
          </div>

          <div id="pfpMsg" style="margin-top:10px;font-size:12px;opacity:.75"></div>
          {% endif %}
        </div>
      </div>

      {% if not allowed %}
        <div class="lockBox">
           This profile is private.<br>
          Follow to see saved places + mood activity.
        </div>
      {% endif %}
    </div>

    <div class="shareCard" id="shareCard">
      <div class="shareTitle">MoodMap Profile Card</div>
      <div class="shareSub">Share this to Instagram/WhatsApp story and go viral.</div>

      <div class="shareInner">
        <div style="display:flex;gap:12px;align-items:center;">
          <div class="pfp" id="sharePfpBox">
            {% if profile_pic %}
              <img id="sharePfpImg" src="{{profile_pic}}" />
            {% else %}
              {{profile_name[:1]}}
            {% endif %}
          </div>
          <div>
            <div style="font-weight:1000;font-size:16px">{{profile_name}}</div>
            <div style="opacity:.7;font-size:12px;margin-top:5px">@{{profile_username}}</div>
            <div style="margin-top:10px;font-size:12px;opacity:.85">
              Current Mood: <b>{{current_mood}}</b>
            </div>
          </div>
        </div>

        <div class="qr">üîó moodmap profile: /u/{{profile_username}}</div>
      </div>

      <div class="hint">Tip: Share button exports this as PNG.</div>
    </div>

  </div>

  <div class="card" style="margin-top:18px">
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap">
      <div style="font-weight:1000;font-size:14px">Saved Places</div>
      <div style="opacity:.65;font-size:12px">Click a place ‚Üí open in Maps</div>
    </div>

    {% if allowed %}
      <div class="places">
        {% for p in places %}
          <div class="place" onclick="openMaps('{{p.lat}}','{{p.lon}}')">
            <div class="pTitle">{{p.name}}</div>
            <div class="pMeta">{{p.category}}</div>
          </div>
        {% endfor %}
      </div>

      {% if places|length == 0 %}
        <div style="opacity:.65;font-size:13px;padding:18px 0">No saved places yet.</div>
      {% endif %}
    {% else %}
      <div style="opacity:.65;font-size:13px;padding:18px 0">
        Saved places are hidden for private profiles.
      </div>
    {% endif %}
  </div>

  

</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>

<script>
const PROFILE_USERNAME = "{{profile_username}}";

const IS_OWNER = document.body.dataset.owner === "1";
const IS_ADMIN = document.body.dataset.admin === "1";

function openMaps(lat, lon){
  window.open(`https://www.google.com/maps?q=${lat},${lon}`, "_blank");
}

function setAllPfps(newUrl){
  const busted = newUrl + (newUrl.includes("?") ? "&" : "?") + "v=" + Date.now();

  const p1 = document.getElementById("profilePfpImg");
  const p2 = document.getElementById("sharePfpImg");

  if(p1) p1.src = busted;
  if(p2) p2.src = busted;

  document.querySelectorAll('img[data-pfp="1"]').forEach(img=>{
    img.src = busted;
  });

  try{
    window.dispatchEvent(new CustomEvent("moodmap:pfp-updated", { detail: { url: newUrl } }));
  }catch(e){}
}

/* follow/unfollow */
const followBtn = document.getElementById("followBtn");
const unfollowBtn = document.getElementById("unfollowBtn");

if(followBtn){
  followBtn.onclick = async ()=>{
    followBtn.disabled = true;
    const r = await fetch("/api/follow/request",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username:PROFILE_USERNAME})
    });
    const d = await r.json();
    if(d.success) location.reload();
    else followBtn.disabled=false;
  };
}

if(unfollowBtn){
  unfollowBtn.onclick = async ()=>{
    unfollowBtn.disabled = true;
    await fetch("/api/follow/unfollow",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username:PROFILE_USERNAME})
    });
    location.reload();
  };
}

/* share */
const shareBtn = document.getElementById("shareBtn");
shareBtn.onclick = async ()=>{
  shareBtn.disabled=true;
  shareBtn.innerText="Generating‚Ä¶";
  try{
    const el = document.getElementById("shareCard");
    const canvas = await html2canvas(el,{scale:2, backgroundColor:null});
    const link = document.createElement("a");
    link.download = `moodmap_${PROFILE_USERNAME}.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();
  }catch(e){
    alert("Share failed.");
  }finally{
    shareBtn.disabled=false;
    shareBtn.innerText=" Share";
  }
};

/* ===================== FOLLOWERS/FOLLOWING UI ===================== */

const ffBackdrop = document.getElementById("ffBackdrop");
const ffModal = document.getElementById("ffModal");
const ffCloseBtn = document.getElementById("ffCloseBtn");
const ffList = document.getElementById("ffList");

const tabFollowers = document.getElementById("tabFollowers");
const tabFollowing = document.getElementById("tabFollowing");

const ffSearch = document.getElementById("ffSearch");

let activeTab = "followers"; // followers | following

let cachedFollowers = [];
let cachedFollowing = [];

function openFFModal(){
  ffBackdrop.classList.add("active");
  ffModal.classList.add("active");
  if(ffSearch){
    ffSearch.value = "";
    setTimeout(()=>ffSearch.focus(), 80);
  }
}
function closeFFModal(){
  ffBackdrop.classList.remove("active");
  ffModal.classList.remove("active");
}
ffBackdrop.addEventListener("click", closeFFModal);
ffCloseBtn.onclick = closeFFModal;

function setTab(t){
  activeTab = t;
  tabFollowers.classList.toggle("active", t === "followers");
  tabFollowing.classList.toggle("active", t === "following");
  if(ffSearch) ffSearch.value = "";
}

function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function makeAvatarHTML(u){
  const pfp = (u.profile_pic || "").trim();
  const letter = (u.name || u.username || "U").slice(0,1).toUpperCase();

  if(pfp){
    return `<img src="${escapeHtml(pfp)}" alt="pfp"/>`;
  }
  return escapeHtml(letter);
}

function buildRelBadges(u){
  const viewerFollows = Number(u.viewer_follows_user || 0) === 1;
  const userFollowsViewer = Number(u.user_follows_viewer || 0) === 1;

  let html = "";

  if(viewerFollows && userFollowsViewer){
    html += `<span class="relBadge mutual">üî• Mutuals</span>`;
  }
  if(userFollowsViewer && !viewerFollows){
    html += `<span class="relBadge followsyou">‚ú® Follows you</span>`;
  }
  if(viewerFollows && !userFollowsViewer){
    html += `<span class="relBadge">Following</span>`;
  }

  return html ? `<div class="ffLabels">${html}</div>` : "";
}

function applySearchFilter(list){
  const q = (ffSearch && ffSearch.value ? ffSearch.value : "").trim().toLowerCase();
  if(!q) return list;

  return list.filter(u=>{
    const a = (u.username || "").toLowerCase();
    const b = (u.name || "").toLowerCase();
    return a.includes(q) || b.includes(q);
  });
}

function renderFFList(list, mode){
  const filtered = applySearchFilter(list);

  if(!filtered.length){
    ffList.innerHTML = `<div class="ffEmpty">${mode === "followers" ? "No followers found." : "No following found."}</div>`;
    return;
  }

  ffList.innerHTML = "";

  filtered.forEach(u=>{
    const div = document.createElement("div");
    div.className = "ffItem";

    const canRemove = IS_OWNER && mode === "followers";
    const canUnfollow = IS_OWNER && mode === "following";

    let actionHTML = `<button class="ffActionBtn">Open</button>`;
    if(canRemove) actionHTML = `<button class="ffActionBtn danger">Remove</button>`;
    if(canUnfollow) actionHTML = `<button class="ffActionBtn danger">Unfollow</button>`;

    div.innerHTML = `
      <div class="ffLeft">
        <div class="ffAvatar">${makeAvatarHTML(u)}</div>
        <div style="min-width:0;">
          <div class="ffName">${escapeHtml(u.name || u.username || "User")}</div>
          <div class="ffUser">@${escapeHtml(u.username)}</div>
          ${buildRelBadges(u)}
        </div>
      </div>
      <div>
        ${actionHTML}
      </div>
    `;

    const btn = div.querySelector("button");

    btn.onclick = async ()=>{
      if(!IS_OWNER){
        location.href="/u/" + u.username;
        return;
      }

      if(mode === "followers"){
        if(!canRemove){
          location.href="/u/" + u.username;
          return;
        }

        const ok = confirm(`Remove @${u.username} from your followers?`);
        if(!ok) return;

        btn.disabled = true;
        btn.innerText = "Removing‚Ä¶";

        try{
          const rr = await fetch("/api/follow/remove_follower",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({username: u.username})
          });
          const rd = await rr.json();

          if(rd && rd.success){
            await refreshStats();
            await loadFollowers(true);
          }else{
            alert("‚ùå Failed to remove follower.");
            btn.disabled = false;
            btn.innerText = "Remove";
          }
        }catch{
          alert("‚ùå Server error.");
          btn.disabled = false;
          btn.innerText = "Remove";
        }
        return;
      }

      if(mode === "following"){
        if(!canUnfollow){
          location.href="/u/" + u.username;
          return;
        }

        const ok = confirm(`Unfollow @${u.username}?`);
        if(!ok) return;

        btn.disabled = true;
        btn.innerText = "Unfollowing‚Ä¶";

        try{
          const rr = await fetch("/api/follow/unfollow",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({username: u.username})
          });
          const rd = await rr.json();

          if(rd && rd.success){
            await refreshStats();
            await loadFollowing(true);
          }else{
            alert("‚ùå Failed to unfollow.");
            btn.disabled = false;
            btn.innerText = "Unfollow";
          }
        }catch{
          alert("‚ùå Server error.");
          btn.disabled = false;
          btn.innerText = "Unfollow";
        }
        return;
      }
    };

    div.onclick = (e)=>{
      if(e.target.tagName.toLowerCase() === "button") return;
      location.href="/u/" + u.username;
    };

    ffList.appendChild(div);
  });
}

async function loadFollowers(silent=false){
  if(!silent) ffList.innerHTML = `<div class="ffEmpty">Loading followers‚Ä¶</div>`;
  try{
    const r = await fetch(`/api/follow/followers?username=${encodeURIComponent(PROFILE_USERNAME)}`);
    const d = await r.json();

    if(!d || !d.success){
      ffList.innerHTML = `<div class="ffEmpty">Failed to load followers.</div>`;
      return;
    }

    cachedFollowers = Array.isArray(d.list) ? d.list : [];

    if(!cachedFollowers.length){
      ffList.innerHTML = `<div class="ffEmpty">No followers yet.</div>`;
      return;
    }

    renderFFList(cachedFollowers, "followers");

  }catch(e){
    ffList.innerHTML = `<div class="ffEmpty">Error loading followers.</div>`;
  }
}

async function loadFollowing(silent=false){
  if(!silent) ffList.innerHTML = `<div class="ffEmpty">Loading following‚Ä¶</div>`;
  try{
    const r = await fetch(`/api/follow/following?username=${encodeURIComponent(PROFILE_USERNAME)}`);
    const d = await r.json();

    if(!d || !d.success){
      ffList.innerHTML = `<div class="ffEmpty">Failed to load following.</div>`;
      return;
    }

    cachedFollowing = Array.isArray(d.list) ? d.list : [];

    if(!cachedFollowing.length){
      ffList.innerHTML = `<div class="ffEmpty">Not following anyone yet.</div>`;
      return;
    }

    renderFFList(cachedFollowing, "following");

  }catch(e){
    ffList.innerHTML = `<div class="ffEmpty">Error loading following.</div>`;
  }
}

tabFollowers.onclick = async ()=>{
  setTab("followers");
  await loadFollowers();
};

tabFollowing.onclick = async ()=>{
  setTab("following");
  await loadFollowing();
};

followersPill.onclick = async ()=>{
  setTab("followers");
  openFFModal();
  await loadFollowers();
};

followingPill.onclick = async ()=>{
  setTab("following");
  openFFModal();
  await loadFollowing();
};

/* ‚úÖ NEW: search live filter */
if(ffSearch){
  ffSearch.addEventListener("input", ()=>{
    if(activeTab === "followers") renderFFList(cachedFollowers, "followers");
    else renderFFList(cachedFollowing, "following");
  });
}

/* ‚úÖ cropper */
let cropper=null;

const cropBackdrop=document.getElementById("cropBackdrop");
const cropModal=document.getElementById("cropModal");
const cropImage=document.getElementById("cropImage");
const cropCloseBtn=document.getElementById("cropCloseBtn");
const zoomInBtn=document.getElementById("zoomInBtn");
const zoomOutBtn=document.getElementById("zoomOutBtn");
const rotateBtn=document.getElementById("rotateBtn");
const saveCropBtn=document.getElementById("saveCropBtn");

function openCropper(file){
  const url = URL.createObjectURL(file);

  cropImage.src=url;
  cropBackdrop.classList.add("active");
  cropModal.classList.add("active");

  if(cropper){
    cropper.destroy();
    cropper=null;
  }

  cropper = new Cropper(cropImage,{
    aspectRatio:1,
    viewMode:1,
    dragMode:"move",
    autoCropArea:1,
    background:false,
    guides:false,
    center:true
  });
}

function closeCropper(){
  cropBackdrop.classList.remove("active");
  cropModal.classList.remove("active");
}

cropBackdrop.addEventListener("click", closeCropper);
cropCloseBtn.onclick = closeCropper;

zoomInBtn.onclick = ()=>{ if(cropper) cropper.zoom(0.1); };
zoomOutBtn.onclick = ()=>{ if(cropper) cropper.zoom(-0.1); };
rotateBtn.onclick = ()=>{ if(cropper) cropper.rotate(90); };

if(IS_OWNER){
  const file=document.getElementById("pfpFile");
  const msg=document.getElementById("pfpMsg");

  file.addEventListener("change", async ()=>{
    const f=file.files?.[0];
    if(!f) return;
    msg.innerText="";
    openCropper(f);
  });

  saveCropBtn.addEventListener("click", ()=>{
    if(!cropper) return;

    msg.innerText="Preparing crop‚Ä¶";

    const canvas = cropper.getCroppedCanvas({
      width:512,
      height:512,
      imageSmoothingQuality:"high"
    });

    canvas.toBlob(async (blob)=>{
      if(!blob){
        msg.innerText="‚ùå Failed to crop image";
        return;
      }

      msg.innerText="Uploading‚Ä¶";
      closeCropper();

      const fd=new FormData();
      fd.append("pfp", blob, "pfp.jpg");

      try{
        const r=await fetch("/api/profile/upload_pfp",{method:"POST",body:fd});
        const d=await r.json();
        if(d.success){
          msg.innerText="‚úÖ Updated!";
          setAllPfps(d.url);
        }else{
          msg.innerText="‚ùå " + (d.message||"Upload failed");
        }
      }catch{
        msg.innerText="‚ùå Upload failed";
      }
    }, "image/jpeg", 0.95);
  });
}

/* ‚úÖ DELETE ACCOUNT */
if(IS_OWNER){
  const deleteBtn = document.getElementById("deleteAccountBtn");
  if(deleteBtn){
    deleteBtn.onclick = async ()=>{
      const ok = confirm("This will permanently delete your MoodMap account.\n\nThis cannot be undone.\n\nContinue?");
      if(!ok) return;

      const password = prompt("Enter your password to confirm deletion:");
      if(!password) return;

      deleteBtn.disabled = true;
      deleteBtn.innerText = "Deleting‚Ä¶";

      try{
        const r = await fetch("/api/account/delete",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({password})
        });

        const d = await r.json();

        if(d.success){
          alert("‚úÖ Account deleted successfully.");
          location.href="/login";
        }else{
          alert("‚ùå " + (d.message || "Delete failed"));
          deleteBtn.disabled = false;
          deleteBtn.innerText = " Delete my account";
        }
      }catch{
        alert("‚ùå Server error");
        deleteBtn.disabled = false;
        deleteBtn.innerText = " Delete my account";
      }
    };
  }
}

/* ‚úÖ MAINTENANCE MODE TOGGLE (ADMIN ONLY) */
(async function initMaintenanceToggle(){
  try{
    if(!IS_ADMIN) return;

    const r = await fetch("/api/admin/maintenance");
    const d = await r.json();
    if(!d || !d.success) return;

    const panel = document.createElement("div");
    panel.className = "card";
    panel.style.marginTop = "18px";

    panel.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap">
        <div>
          <div style="font-weight:1000;font-size:14px">Admin Controls</div>
          <div style="opacity:.7;font-size:12px;margin-top:6px;line-height:1.4">
            Toggle maintenance mode. When ON, everyone sees Maintenance page except login/reset/admin toggle.
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <span id="maintBadge" class="badge">Loading‚Ä¶</span>
          <button id="maintBtn" class="btn primary">Toggle</button>
        </div>
      </div>
    `;

    const wrap = document.querySelector(".wrap");
    if(wrap) wrap.appendChild(panel);

    const badge = document.getElementById("maintBadge");
    const btn = document.getElementById("maintBtn");

    function updateBadge(isOn){
      badge.innerText = isOn ? "Maintenance: ON" : "Maintenance: OFF";
      badge.style.borderColor = isOn ? "rgba(34,197,94,0.35)" : "rgba(239,68,68,0.35)";
      badge.style.background = isOn ? "rgba(34,197,94,0.18)" : "rgba(239,68,68,0.16)";
    }

    updateBadge(Boolean(d.maintenance));

    btn.onclick = async ()=>{
      btn.disabled = true;
      btn.innerText = "Toggling‚Ä¶";

      try{
        const g = await fetch("/api/admin/maintenance");
        const gd = await g.json();
        const next = !Boolean(gd.maintenance);

        const rr = await fetch("/api/admin/maintenance",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({maintenance: next})
        });
        const rd = await rr.json();

        if(rd && rd.success){
          updateBadge(Boolean(rd.maintenance));
          alert(rd.maintenance
            ? "‚úÖ Maintenance enabled. Everyone will see maintenance page now."
            : "‚úÖ Maintenance disabled. Site is live again."
          );
        }else{
          alert("‚ùå Toggle failed");
        }

      }catch{
        alert("‚ùå Server error");
      }finally{
        btn.disabled = false;
        btn.innerText = "Toggle";
      }
    };

  }catch(e){}
})();
</script>

</body>
</html>
